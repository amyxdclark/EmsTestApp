<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MedChecks / SupplyChecks</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0a3431">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Bootstrap + jQuery (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- QR Scanner (html5-qrcode) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --mc-bg1:#041a18;
      --mc-bg2:#0a3431;   /* dark seafoam */
      --mc-accent:#2fb7a2;
      --mc-soft:#b9fff3;

      --sc-bg1:#1b0506;   /* dark red */
      --sc-bg2:#4b0f12;
      --sc-accent:#ff6b6b;
      --sc-soft:#ffd2d2;

      --card-border: rgba(255,255,255,.55);
      --text: rgba(255,255,255,.92);
      --text-muted: rgba(255,255,255,.70);

      --panel-bg: rgba(255,255,255,.10);
      --white: #ffffff;
      --dark: #0b0f10;

      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;

      --shadow-none: none; /* per request: no shadows */
    }

    body{
      min-height:100vh;
      color: var(--text);
      background: linear-gradient(135deg, var(--mc-bg1), var(--mc-bg2));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Mode: SupplyChecks */
    body.mode-supply{
      background: linear-gradient(135deg, var(--sc-bg1), var(--sc-bg2));
    }

    .brand-badge{
      border: 1px solid var(--card-border);
      border-radius: 999px;
      padding: .35rem .75rem;
      display:inline-flex;
      gap:.5rem;
      align-items:center;
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 700;
      letter-spacing: .2px;
    }

    .topbar{
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.20);
      border-bottom: 1px solid rgba(255,255,255,.15);
    }

    .nav-link, .navbar-brand { color: var(--text) !important; }
    .nav-link.active{ text-decoration: underline; text-underline-offset: .35rem; }

    .pill{
      border: 1px solid var(--card-border);
      border-radius: 999px;
      padding: .35rem .7rem;
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size: .9rem;
      white-space: nowrap;
    }

    .btn-white{
      background: var(--white);
      color: #0b1112;
      border: 1px solid rgba(255,255,255,.85);
      border-radius: 999px;
      font-weight: 700;
      padding: .55rem 1rem;
    }
    .btn-white:active{ transform: translateY(1px); }

    .btn-outline-white{
      background: transparent;
      border: 1px solid var(--card-border);
      border-radius: 999px;
      color: var(--text);
      font-weight: 700;
      padding: .55rem 1rem;
    }

    .page-wrap{
      max-width: 1160px;
      margin: 0 auto;
      padding: 1rem;
      padding-bottom: 6rem;
    }

    .section-card{
      border: 1px solid var(--card-border);
      border-radius: var(--radius-xl);
      background: rgba(255,255,255,.08);
      padding: 1rem;
      margin-top: 1rem;
    }

    .section-header{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 1rem;
      flex-wrap: wrap;
      padding: .25rem .25rem .75rem .25rem;
    }

    .section-title{
      display:flex;
      align-items:center;
      gap: .75rem;
      margin: 0;
      font-size: 1.15rem;
      font-weight: 800;
    }

    .section-sub{
      color: var(--text-muted);
      font-size: .9rem;
      margin: .2rem 0 0 0;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .square-btn{
      grid-column: span 6;
      border-radius: var(--radius-lg);
      background: #ffffff;
      border: 1px solid rgba(255,255,255,.85);
      color: #0b1112;
      padding: 14px;
      text-align:left;
      user-select:none;
      cursor:pointer;
      min-height: 86px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      box-shadow: var(--shadow-none);
    }
    .square-btn .label{
      font-weight: 900;
      line-height: 1.1;
    }
    .square-btn .meta{
      font-size: .85rem;
      color: rgba(0,0,0,.60);
      margin-top: 6px;
    }
    .square-btn .tag{
      font-size: .75rem;
      font-weight: 800;
      padding: .25rem .5rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      color: rgba(0,0,0,.70);
      background: rgba(0,0,0,.04);
      white-space: nowrap;
    }
    .square-btn:active{ transform: translateY(1px); }

    /* responsive */
    @media (min-width: 576px){
      .square-btn{ grid-column: span 4; }
    }
    @media (min-width: 992px){
      .square-btn{ grid-column: span 3; }
    }

    .panel-white{
      background: #fff;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,.85);
      padding: 14px;
      color: #0b1112;
    }

    .muted-white{ color: var(--text-muted); }

    .kbd{
      border: 1px solid rgba(255,255,255,.30);
      border-bottom-width: 2px;
      border-radius: 8px;
      padding: 2px 7px;
      font-weight: 800;
      font-size: .85rem;
      color: var(--text);
      background: rgba(255,255,255,.08);
    }

    .toast-host{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      width: min(540px, calc(100% - 24px));
    }

    .help-doc h6{ margin-top: 1rem; font-weight: 900; }
    .help-doc ul{ margin-bottom: .75rem; }
    .small-note{ font-size: .9rem; color: rgba(0,0,0,.65); }

    /* hide/show views */
    .view{ display:none; }
    .view.active{ display:block; }

    .mini-chip{
      font-size:.78rem;
      font-weight:800;
      padding:.22rem .55rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.45);
      background: rgba(255,255,255,.08);
      color: var(--text);
      white-space: nowrap;
    }

    .list-tight{ margin: 0; padding-left: 1.1rem; }
    .list-tight li{ margin: .2rem 0; }

    .table-lite td, .table-lite th{
      padding: .55rem .6rem;
      vertical-align: middle;
    }

    .required-star{ color:#ffef6b; font-weight:900; }

    /* Modal */
    .modal-content{
      border-radius: 18px;
    }
  </style>
</head>

<body class="mode-med">
  <!-- Top Nav -->
  <nav class="navbar navbar-expand-lg topbar sticky-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#" onclick="return false;">
        <span class="brand-badge">
          <span id="brandName">MedChecks</span>
          <span class="mini-chip" id="modeChip">MED</span>
        </span>
      </a>

      <button class="navbar-toggler btn-outline-white" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        Menu
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="#" data-nav="home">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="iwant">I want to…</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="reports">Reports</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="help">Help</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="admin" id="adminNav" style="display:none;">Admin</a></li>
        </ul>

        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="pill" id="whoPill">Not logged in</span>
          <button class="btn-outline-white" id="btnSwitchMode" type="button">Switch Mode</button>
          <button class="btn-white" id="btnLogout" type="button" style="display:none;">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="page-wrap">

    <!-- LOGIN VIEW -->
    <div class="view active" id="view-login">
      <div class="section-card mt-3">
        <div class="section-header">
          <div>
            <h2 class="section-title mb-1">Login</h2>
            <div class="section-sub">Concept login (not secure). Use <span class="kbd">admin/admin</span> or <span class="kbd">user/user</span>.</div>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Username</label>
              <input id="loginUser" class="form-control form-control-lg" value="admin" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Password</label>
              <input id="loginPass" class="form-control form-control-lg" value="admin" />
            </div>
            <div class="col-12 col-md-4">
              <button id="btnLogin" class="btn btn-dark btn-lg w-100" type="button">Login</button>
              <div class="small-note mt-2">Auto-filled for quick demo.</div>
            </div>
          </div>
        </div>

        <!-- Post-login service picker (required) -->
        <div class="panel-white mt-3" id="servicePickerPanel" style="display:none;">
          <h5 class="fw-black mb-2" style="font-weight:900;">Select Service <span class="required-star">*</span></h5>
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <select id="serviceSelect" class="form-select form-select-lg">
                <option value="">-- Choose Service --</option>
                <option value="MC1">MC1</option>
                <option value="Lisbon">Lisbon</option>
              </select>
              <div class="small-note mt-2">
                This determines which Supply Room + units you see (MC1 vs Lisbon).
              </div>
            </div>
            <div class="col-12 col-md-6">
              <button id="btnEnterApp" class="btn btn-success btn-lg w-100" type="button">Enter</button>
              <div class="small-note mt-2">You must pick a service to continue.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN HOME VIEW -->
    <div class="view" id="view-home">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">Quick Actions</h3>
            <div class="section-sub">Tap a location to start a checklist or scan items. (Mode + Service changes what appears.)</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <span class="pill">Service: <b id="servicePill">—</b></span>
            <span class="pill">Mode: <b id="modePill">MedChecks</b></span>
          </div>
        </div>

        <!-- Inventory + Manage -->
        <div class="grid" id="grid-inventory-manage"></div>
      </div>

      <!-- Daily/Monthly checks -->
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">Daily / Monthly Checks</h3>
            <div class="section-sub">These launch an actual checklist (not just “mark complete”).</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn-outline-white" type="button" id="btnResetChecks">Reset Demo Check Status</button>
          </div>
        </div>

        <div class="grid" id="grid-checks"></div>
      </div>
    </div>

    <!-- I WANT TO VIEW -->
    <div class="view" id="view-iwant">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">I want to…</h3>
            <div class="section-sub">9 scenario shortcuts. Includes “Create an Incident” (PDF export).</div>
          </div>
        </div>
        <div class="grid" id="grid-iwant"></div>
      </div>
    </div>

    <!-- REPORTS VIEW -->
    <div class="view" id="view-reports">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">Reports</h3>
            <div class="section-sub">Basic demo reporting tools (local-only).</div>
          </div>
        </div>
        <div class="grid" id="grid-reports"></div>

        <div class="panel-white mt-3">
          <h5 class="fw-black" style="font-weight:900;">Recent Activity (Local Log)</h5>
          <div class="small-note">Stored in browser storage for this demo.</div>
          <div class="table-responsive mt-2">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>User</th>
                  <th>Service</th>
                  <th>Mode</th>
                  <th>Action</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="logTableBody"></tbody>
            </table>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-secondary" type="button" id="btnClearLogs">Clear Logs</button>
            <button class="btn btn-outline-secondary" type="button" id="btnExportLogsJson">Export Logs (JSON)</button>
          </div>
          <pre class="mt-3 p-2 rounded" style="background:#f6f7f8; border:1px solid #e5e7ea; display:none;" id="logExportBox"></pre>
        </div>
      </div>
    </div>

    <!-- HELP VIEW -->
    <div class="view" id="view-help">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">Help Documentation</h3>
            <div class="section-sub">Everything here is local and meant for concept/prototyping.</div>
          </div>
        </div>

        <div class="panel-white help-doc">
          <h5 style="font-weight:900;">How this prototype works</h5>
          <ul class="list-tight">
            <li><b>Login</b> with <span class="kbd">admin/admin</span> or <span class="kbd">user/user</span>.</li>
            <li><b>Select a Service</b> (MC1 or Lisbon) to load the correct supply rooms / kits.</li>
            <li><b>Switch Mode</b> (MedChecks vs SupplyChecks) using the top button.</li>
            <li><b>Locations</b> launch checklists. Items can be “scanned” via QR (demo list) or manually chosen.</li>
            <li><b>Incident</b> lets you select items used and generate a PDF summary for your run report attachment.</li>
          </ul>

          <h6>Modes</h6>
          <ul class="list-tight">
            <li><b>MedChecks</b>: Medication-focused lists (common EMS meds).</li>
            <li><b>SupplyChecks</b>: Supply-focused lists (airway, trauma, IV supplies, etc.).</li>
          </ul>

          <h6>Services (Companies)</h6>
          <ul class="list-tight">
            <li><b>MC1</b>: shows MC1 Supply Room + MC1 kits.</li>
            <li><b>Lisbon</b>: shows Lisbon Supply Room + Lisbon unit locations.</li>
          </ul>

          <h6>QR Scanning</h6>
          <ul class="list-tight">
            <li>Uses <b>html5-qrcode</b> (camera). On iOS, allow camera permissions.</li>
            <li>If camera fails, use the <b>manual</b> picker in the checklist modal.</li>
          </ul>

          <h6>Data storage</h6>
          <ul class="list-tight">
            <li>Uses <b>localStorage</b> for session + logs + check completion (demo).</li>
            <li>No server, no real auth, and no multi-device sync (prototype only).</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ADMIN VIEW -->
    <div class="view" id="view-admin">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">Admin: Master Lists</h3>
            <div class="section-sub">Edit meds/supplies master lists (saved to local storage).</div>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h5 style="font-weight:900;">Med Master List</h5>
              <div class="small-note">One item per line. Format: <b>Name | Default Dose | Notes</b></div>
              <textarea class="form-control" id="adminMeds" rows="14" spellcheck="false"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveMeds">Save Meds</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetMeds">Reset Default</button>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <h5 style="font-weight:900;">Supply Master List</h5>
              <div class="small-note">One item per line. Format: <b>Name | Par Level | Notes</b></div>
              <textarea class="form-control" id="adminSupplies" rows="14" spellcheck="false"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveSupplies">Save Supplies</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetSupplies">Reset Default</button>
              </div>
            </div>

            <div class="col-12">
              <hr/>
              <h5 style="font-weight:900;">Locations (Demo)</h5>
              <div class="small-note">This prototype uses built-in logic per Service + Mode. You can expand this later to be fully editable.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- CHECKLIST MODAL -->
  <div class="modal fade" id="checklistModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="checklistTitle" style="font-weight:900;">Checklist</h5>
            <div class="small-note" id="checklistSubtitle">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex gap-2 flex-wrap mb-2">
            <button class="btn btn-outline-secondary" type="button" id="btnScanQr">Scan QR</button>
            <button class="btn btn-outline-secondary" type="button" id="btnStopScan" disabled>Stop Scan</button>
            <button class="btn btn-outline-secondary" type="button" id="btnAddManual">Add Manually</button>
            <span class="ms-auto small-note">Tip: demo QR values are like <b>MED:Ondansetron</b> or <b>SUP:4x4 Gauze</b></span>
          </div>

          <div id="qrRegionWrap" style="display:none;">
            <div class="p-2 rounded" style="border:1px solid #e5e7ea; background:#f8f9fa;">
              <div id="qr-reader" style="width:100%;"></div>
              <div class="small-note mt-2">If you get camera errors, use “Add Manually”.</div>
            </div>
          </div>

          <div class="mt-3">
            <h6 style="font-weight:900;">Checklist Items</h6>
            <div class="table-responsive">
              <table class="table table-sm table-lite">
                <thead>
                  <tr>
                    <th style="width:90px;">Done</th>
                    <th>Item</th>
                    <th style="width:160px;">Dose/Qty</th>
                    <th>Notes</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="checklistBody"></tbody>
              </table>
            </div>
          </div>

          <div class="small-note">
            Saving marks this checklist as completed for the day/month when applicable and records a log entry.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-success" type="button" id="btnSaveChecklist">Save Checklist</button>
        </div>
      </div>
    </div>
  </div>

  <!-- INCIDENT MODAL -->
  <div class="modal fade" id="incidentModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" style="font-weight:900;">Create Incident</h5>
            <div class="small-note">Select items used and export a PDF to attach to your run report later.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Incident Number</label>
              <input class="form-control" id="incidentNumber" placeholder="e.g., 2026-002134" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Patient / Notes (optional)</label>
              <input class="form-control" id="incidentNotes" placeholder="e.g., chest pain / SVT / trauma..." />
            </div>
          </div>

          <hr class="my-3"/>

          <div class="d-flex gap-2 flex-wrap align-items-center">
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentAdd">Add Item</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentScan">Scan QR</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentStop" disabled>Stop Scan</button>
          </div>

          <div id="qrIncidentWrap" style="display:none;" class="mt-2">
            <div class="p-2 rounded" style="border:1px solid #e5e7ea; background:#f8f9fa;">
              <div id="qr-reader-incident" style="width:100%;"></div>
              <div class="small-note mt-2">QR format: <b>MED:Ketorolac</b> or <b>SUP:NPA 28F</b></div>
            </div>
          </div>

          <div class="mt-3">
            <h6 style="font-weight:900;">Items Used</h6>
            <div class="table-responsive">
              <table class="table table-sm table-lite">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Item</th>
                    <th style="width:180px;">Dose/Qty</th>
                    <th>Details</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="incidentBody"></tbody>
              </table>
            </div>
          </div>

          <div class="small-note">
            Export generates a simple PDF using jsPDF (client-side).
          </div>

        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-dark" type="button" id="btnIncidentExportPdf">Export PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple picker modal (reused) -->
  <div class="modal fade" id="pickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="pickerTitle" style="font-weight:900;">Pick an Item</h5>
            <div class="small-note" id="pickerSubtitle">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <input class="form-control" id="pickerSearch" placeholder="Search..." />
            </div>
            <div class="col-12 col-md-6">
              <select class="form-select" id="pickerType">
                <option value="auto">Auto (current mode)</option>
                <option value="med">Meds</option>
                <option value="sup">Supplies</option>
              </select>
            </div>
          </div>
          <div class="mt-3" id="pickerList"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-host" id="toastHost"></div>

  <script>
    // -----------------------
    // PWA Service Worker
    // -----------------------
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          await navigator.serviceWorker.register("./sw.js", { scope: "./" });
          console.log("Service worker registered.");
        } catch (e) {
          console.warn("Service worker registration failed:", e);
        }
      });
    }

    // -----------------------
    // Storage Keys
    // -----------------------
    const K = {
      session: "mc_session",
      logs: "mc_logs",
      checks: "mc_checks",
      meds: "mc_master_meds",
      supplies: "mc_master_supplies"
    };

    // -----------------------
    // Defaults: Master lists
    // -----------------------
    const DEFAULT_MEDS = [
      "Aspirin | 324 mg PO | chewable",
      "Nitroglycerin | 0.4 mg SL | per protocol/contraindications",
      "Ondansetron | 4 mg IV/ODT | nausea/vomiting",
      "Dextrose (D10) | 100-250 mL IV | hypoglycemia",
      "Glucagon | 1 mg IM | hypoglycemia no IV",
      "Epinephrine 1:10,000 | 1 mg IV/IO | cardiac arrest",
      "Epinephrine 1:1,000 | 0.3 mg IM | anaphylaxis",
      "Albuterol | 2.5 mg neb | wheeze/bronchospasm",
      "Ipratropium | 0.5 mg neb | with albuterol",
      "Naloxone | 0.4-2 mg IN/IV | opioid overdose",
      "Ketorolac | 15-30 mg IV/IM | pain (per protocol)",
      "Fentanyl | 25-100 mcg IV/IN | pain (per protocol)",
      "Morphine | 2-10 mg IV | pain (per protocol)",
      "Midazolam | 2-5 mg IV/IM/IN | seizures/agitation",
      "Acetaminophen | 1,000 mg PO/IV | pain/fever"
    ].join("\n");

    const DEFAULT_SUPPLIES = [
      "O2 Nasal Cannula | Par 10 | adult",
      "O2 Non-Rebreather Mask | Par 6 | adult",
      "BVM Adult | Par 2 | with PEEP valve if available",
      "OPA assorted | Par 1 set | sizes",
      "NPA assorted | Par 1 set | w/ lube",
      "i-gel / SGA assorted | Par 1 set | sizes",
      "Suction Yankauer | Par 4 | disposable",
      "Suction Catheter | Par 6 | assorted",
      "IV Start Kit | Par 10 | tourniquet/alcohol/chg",
      "18ga IV Catheter | Par 10 | ",
      "20ga IV Catheter | Par 10 | ",
      "22ga IV Catheter | Par 6 | ",
      "Saline Flush | Par 20 | 10mL",
      "0.9% NS 1L | Par 6 | fluids",
      "4x4 Gauze | Par 20 | ",
      "ABD Pads | Par 10 | ",
      "Trauma Dressing | Par 6 | ",
      "Coban | Par 10 | ",
      "Tape 1 inch | Par 6 | ",
      "SAM Splint | Par 2 | ",
      "Trauma Shears | Par 2 | ",
      "BP Cuff Adult | Par 1 | "
    ].join("\n");

    // -----------------------
    // Session model
    // -----------------------
    function getSession(){
      return JSON.parse(localStorage.getItem(K.session) || "null");
    }
    function setSession(s){
      localStorage.setItem(K.session, JSON.stringify(s));
    }
    function clearSession(){
      localStorage.removeItem(K.session);
    }

    // -----------------------
    // Logs
    // -----------------------
    function getLogs(){
      return JSON.parse(localStorage.getItem(K.logs) || "[]");
    }
    function setLogs(arr){
      localStorage.setItem(K.logs, JSON.stringify(arr));
    }
    function addLog(action, details){
      const s = getSession() || {};
      const logs = getLogs();
      logs.unshift({
        t: new Date().toISOString(),
        user: s.user || "—",
        role: s.role || "—",
        service: s.service || "—",
        mode: s.mode || "MedChecks",
        action, details
      });
      setLogs(logs.slice(0, 200));
      renderLogs();
    }

    // -----------------------
    // Checks state (demo)
    // -----------------------
    function getChecksState(){
      return JSON.parse(localStorage.getItem(K.checks) || "{}");
    }
    function setChecksState(obj){
      localStorage.setItem(K.checks, JSON.stringify(obj));
    }

    // -----------------------
    // Masters
    // -----------------------
    function getMasterMeds(){
      return localStorage.getItem(K.meds) || DEFAULT_MEDS;
    }
    function getMasterSupplies(){
      return localStorage.getItem(K.supplies) || DEFAULT_SUPPLIES;
    }

    function parseMasterLines(text){
      return (text || "")
        .split("\n")
        .map(x => x.trim())
        .filter(Boolean)
        .map(line => {
          const parts = line.split("|").map(p => p.trim());
          return {
            name: parts[0] || line,
            doseOrPar: parts[1] || "",
            notes: parts[2] || ""
          };
        });
    }

    // -----------------------
    // Mode + Theme
    // -----------------------
    function applyMode(mode){
      const body = document.body;
      const isSupply = mode === "SupplyChecks";
      body.classList.toggle("mode-supply", isSupply);
      $("#brandName").text(isSupply ? "SupplyChecks" : "MedChecks");
      $("#modeChip").text(isSupply ? "SUP" : "MED");
      $("#modePill").text(isSupply ? "SupplyChecks" : "MedChecks");

      // theme-color update (nice on mobile address bar)
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.setAttribute("content", isSupply ? "#4b0f12" : "#0a3431");
    }

    // -----------------------
    // Locations (split meds vs supplies) + Service variations
    // -----------------------
    function buildLocations(session){
      const service = session.service;     // MC1 or Lisbon
      const mode = session.mode;           // MedChecks or SupplyChecks

      // shared unit locations
      const baseUnit = [
        { id:"u43-narc", label:"Unit 43 Narcotic Box", type:"med" },
        { id:"u43-obo",  label:"Unit 43 Out of Box",   type:"med" },
        { id:"u42-narc", label:"Unit 42 Narcotic Box", type:"med" },
        { id:"u42-obo",  label:"Unit 42 Out of Box",   type:"med" },
        { id:"u42-jump", label:"Unit 42 Jump Kit",     type:"sup" },
        { id:"u42-cab",  label:"Unit 42 Cabinet",      type:"sup" }
      ];

      // service-specific (company) locations
      const serviceSpecific = [];
      if (service === "MC1"){
        serviceSpecific.push(
          { id:"mc1-narc", label:"MC1 Narcotics", type:"med" },
          { id:"mc1-medbox", label:"MC1 Medication Box", type:"med" },
          { id:"mc1-jump", label:"MC1 Jump Kit", type:"sup" },
          { id:"sr-mc1", label:"Supply Room (MC1)", type:"sup" }
        );
      } else {
        serviceSpecific.push(
          { id:"sr-lisbon", label:"Supply Room (Lisbon)", type:"sup" }
        );
      }

      // both services have a med supply room concept too (med stock)
      const medSupplyRooms = [
        { id:"med-sr", label:"Medication Stock Room", type:"med" }
      ];

      // Combine
      const all = [...medSupplyRooms, ...serviceSpecific, ...baseUnit];

      // In MedChecks mode, show primarily meds + a couple common supply spots if you want.
      // In SupplyChecks mode, show supplies + cabinets/kits/rooms.
      if (mode === "MedChecks"){
        return all.filter(x => x.type === "med");
      } else {
        return all.filter(x => x.type === "sup");
      }
    }

    // -----------------------
    // Daily / Monthly checklist definitions (launch checklist)
    // -----------------------
    function buildCheckDefinitions(session){
      const service = session.service;

      const today = new Date();
      const ymd = today.toISOString().slice(0,10);
      const ym = ymd.slice(0,7);

      const checks = [];

      // Out of box meds daily (per unit)
      checks.push(
        { id:`chk-u42-obo-${ymd}`, label:"Daily: Unit 42 Out of Box", cadence:"daily", locationId:"u42-obo", itemType:"med" },
        { id:`chk-u43-obo-${ymd}`, label:"Daily: Unit 43 Out of Box", cadence:"daily", locationId:"u43-obo", itemType:"med" }
      );

      // Units daily supply check (kits/cabinet)
      checks.push(
        { id:`chk-u42-jump-${ymd}`, label:"Daily: Unit 42 Jump Kit", cadence:"daily", locationId:"u42-jump", itemType:"sup" },
        { id:`chk-u42-cab-${ymd}`, label:"Daily: Unit 42 Cabinet", cadence:"daily", locationId:"u42-cab", itemType:"sup" }
      );

      // Supply room monthly (service-specific supply room)
      if (service === "MC1"){
        checks.push({ id:`chk-sr-mc1-${ym}`, label:"Monthly: Supply Room (MC1)", cadence:"monthly", locationId:"sr-mc1", itemType:"sup" });
      } else {
        checks.push({ id:`chk-sr-lisbon-${ym}`, label:"Monthly: Supply Room (Lisbon)", cadence:"monthly", locationId:"sr-lisbon", itemType:"sup" });
      }

      // MC1 daily kit checks
      if (service === "MC1"){
        checks.push({ id:`chk-mc1-jump-${ymd}`, label:"Daily: MC1 Jump Kit", cadence:"daily", locationId:"mc1-jump", itemType:"sup" });
        checks.push({ id:`chk-mc1-medbox-${ymd}`, label:"Daily: MC1 Medication Box", cadence:"daily", locationId:"mc1-medbox", itemType:"med" });
      }

      return checks;
    }

    // -----------------------
    // Scenario shortcuts (9)
    // -----------------------
    const I_WANT_SCENARIOS = [
      { id:"scan-item", label:"Scan an item", meta:"Use camera QR to add to a checklist", tag:"QR" },
      { id:"stock", label:"Stock items", meta:"Add meds/supplies into a location", tag:"Inventory" },
      { id:"transfer", label:"Transfer items", meta:"Move between locations", tag:"Inventory" },
      { id:"remove", label:"Remove items", meta:"Sent out / expired / quarantine", tag:"Inventory" },
      { id:"use", label:"Use medication", meta:"Full/partial use (demo)", tag:"Med" },
      { id:"waste", label:"Waste medication", meta:"Witness concept (demo)", tag:"Med" },
      { id:"daily-check", label:"Run today's check", meta:"Launch daily checklist", tag:"Checklist" },
      { id:"report-discrep", label:"Report discrepancy", meta:"Missing / damaged / count issue", tag:"Report" },
      { id:"incident", label:"Create an incident", meta:"Select used items + export PDF", tag:"PDF" }
    ];

    // Reports
    const REPORT_BUTTONS = [
      { id:"history", label:"History", meta:"View recent actions", tag:"Log" },
      { id:"search-logs", label:"Search Logs", meta:"Filter by keywords", tag:"Log" },
      { id:"report-discrepancy", label:"Report Discrepancy", meta:"Create a discrepancy record", tag:"Report" }
    ];

    // -----------------------
    // Rendering Helpers
    // -----------------------
    function setActiveNav(key){
      $(".nav-link").removeClass("active");
      $(`.nav-link[data-nav="${key}"]`).addClass("active");
    }

    function showView(name){
      $(".view").removeClass("active");
      $(`#view-${name}`).addClass("active");
      setActiveNav(name === "home" ? "home" : name);
    }

    function renderInventoryManage(){
      const s = getSession();
      if (!s) return;

      const items = buildLocations(s);

      // Split into 2 big sections: Inventory + Manage (same buttons as requested)
      // We'll display two headers inside one combined area for compactness.
      const wrap = $("#grid-inventory-manage");
      wrap.empty();

      const invHeader = $(`
        <div class="col-12" style="grid-column: span 12;">
          <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-1">
            <div>
              <h4 class="mb-0" style="font-weight:900;">Inventory</h4>
              <div class="muted-white">Start a checklist or scan items into inventory.</div>
            </div>
            <span class="pill">Showing: <b>${s.mode === "MedChecks" ? "Meds" : "Supplies"}</b></span>
          </div>
        </div>
      `);
      wrap.append(invHeader);

      items.forEach(loc => {
        wrap.append(squareButton(loc.label, s.mode === "MedChecks" ? "MED" : "SUP", "Open checklist", () => openChecklistForLocation(loc)));
      });

      const manHeader = $(`
        <div class="col-12 mt-2" style="grid-column: span 12;">
          <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-1">
            <div>
              <h4 class="mb-0" style="font-weight:900;">Manage</h4>
              <div class="muted-white">Same locations (prototype). Later: add transfers, par-levels, expirations.</div>
            </div>
          </div>
        </div>
      `);
      wrap.append(manHeader);

      items.forEach(loc => {
        wrap.append(squareButton(loc.label, "MANAGE", "Open checklist", () => openChecklistForLocation(loc)));
      });
    }

    function renderChecks(){
      const s = getSession();
      if (!s) return;

      const checks = buildCheckDefinitions(s);
      const state = getChecksState();

      const wrap = $("#grid-checks");
      wrap.empty();

      checks.forEach(chk => {
        const done = !!state[chk.id];
        const tag = chk.cadence.toUpperCase() + (done ? " ✓" : "");
        const meta = done ? "Saved (tap to view/edit)" : "Tap to perform checklist";
        wrap.append(squareButton(chk.label, tag, meta, () => openChecklistForCheck(chk)));
      });
    }

    function renderIWant(){
      const wrap = $("#grid-iwant");
      wrap.empty();
      I_WANT_SCENARIOS.forEach(scn => {
        wrap.append(squareButton(scn.label, scn.tag, scn.meta, () => handleScenario(scn.id)));
      });
    }

    function renderReports(){
      const wrap = $("#grid-reports");
      wrap.empty();
      REPORT_BUTTONS.forEach(r => {
        wrap.append(squareButton(r.label, r.tag, r.meta, () => handleReport(r.id)));
      });
    }

    function squareButton(label, tag, meta, onClick){
      const el = $(`
        <div class="square-btn">
          <div>
            <div class="label">${escapeHtml(label)}</div>
            <div class="meta">${escapeHtml(meta || "")}</div>
          </div>
          <div class="tag">${escapeHtml(tag || "")}</div>
        </div>
      `);
      el.on("click", onClick);
      return el;
    }

    function renderLogs(){
      const logs = getLogs();
      const tbody = $("#logTableBody");
      tbody.empty();
      logs.slice(0, 50).forEach(l => {
        const dt = new Date(l.t);
        tbody.append(`
          <tr>
            <td>${escapeHtml(dt.toLocaleString())}</td>
            <td>${escapeHtml(l.user)} (${escapeHtml(l.role)})</td>
            <td>${escapeHtml(l.service)}</td>
            <td>${escapeHtml(l.mode)}</td>
            <td>${escapeHtml(l.action)}</td>
            <td>${escapeHtml(l.details || "")}</td>
          </tr>
        `);
      });
    }

    // -----------------------
    // Checklist State + UI
    // -----------------------
    let currentChecklist = null; // { kind: "location"|"check", id, title, subtitle, itemType, rows: [...] }
    let qrScanner = null;

    function openChecklistForLocation(loc){
      const s = getSession();
      const itemType = loc.type || (s.mode === "MedChecks" ? "med" : "sup");
      const title = `${loc.label}`;
      const subtitle = `${s.service} • ${s.mode} • ${itemType.toUpperCase()} checklist`;

      const saved = loadChecklistState(`loc:${loc.id}`);
      currentChecklist = {
        kind:"location",
        storageKey:`loc:${loc.id}`,
        title,
        subtitle,
        itemType,
        rows: saved?.rows || seedChecklistRows(itemType)
      };
      showChecklistModal();
      addLog("Open Checklist", loc.label);
    }

    function openChecklistForCheck(chk){
      const s = getSession();
      // Ensure location exists in this mode? We'll still allow it.
      const title = chk.label;
      const subtitle = `${s.service} • ${chk.cadence} • ${chk.itemType.toUpperCase()} • ${chk.locationId}`;

      const storageKey = `chk:${chk.id}`;
      const saved = loadChecklistState(storageKey);
      currentChecklist = {
        kind:"check",
        storageKey,
        title,
        subtitle,
        itemType: chk.itemType,
        checkId: chk.id,
        cadence: chk.cadence,
        rows: saved?.rows || seedChecklistRows(chk.itemType)
      };
      showChecklistModal();
      addLog("Open Scheduled Check", chk.label);
    }

    function seedChecklistRows(itemType){
      // Use first 8 items from master as demo seed
      const list = itemType === "med" ? parseMasterLines(getMasterMeds()) : parseMasterLines(getMasterSupplies());
      return list.slice(0, 8).map(x => ({
        done: false,
        item: x.name,
        doseQty: (itemType === "med" ? x.doseOrPar : x.doseOrPar.replace("Par ","")) || "",
        notes: x.notes || ""
      }));
    }

    function showChecklistModal(){
      $("#checklistTitle").text(currentChecklist.title);
      $("#checklistSubtitle").text(currentChecklist.subtitle);
      renderChecklistRows();
      stopQrIfRunning();
      $("#qrRegionWrap").hide();
      $("#btnStopScan").prop("disabled", true);
      new bootstrap.Modal(document.getElementById("checklistModal")).show();
    }

    function renderChecklistRows(){
      const body = $("#checklistBody");
      body.empty();
      currentChecklist.rows.forEach((r, idx) => {
        body.append(`
          <tr>
            <td>
              <input type="checkbox" class="form-check-input" data-idx="${idx}" ${r.done ? "checked":""} />
            </td>
            <td><b>${escapeHtml(r.item)}</b></td>
            <td><input class="form-control form-control-sm" data-field="doseQty" data-idx="${idx}" value="${escapeAttr(r.doseQty)}" /></td>
            <td><input class="form-control form-control-sm" data-field="notes" data-idx="${idx}" value="${escapeAttr(r.notes)}" /></td>
            <td><button class="btn btn-sm btn-outline-danger" data-del="${idx}">X</button></td>
          </tr>
        `);
      });

      // bind
      body.find('input[type="checkbox"]').off("change").on("change", function(){
        const i = +$(this).data("idx");
        currentChecklist.rows[i].done = this.checked;
      });
      body.find('input[data-field]').off("input").on("input", function(){
        const i = +$(this).data("idx");
        const f = $(this).data("field");
        currentChecklist.rows[i][f] = $(this).val();
      });
      body.find('button[data-del]').off("click").on("click", function(){
        const i = +$(this).data("del");
        currentChecklist.rows.splice(i,1);
        renderChecklistRows();
      });
    }

    function saveChecklist(){
      if (!currentChecklist) return;

      // persist checklist rows
      persistChecklistState(currentChecklist.storageKey, { rows: currentChecklist.rows });

      // mark scheduled check done (if applicable)
      if (currentChecklist.kind === "check" && currentChecklist.checkId){
        const st = getChecksState();
        st[currentChecklist.checkId] = true;
        setChecksState(st);
      }

      addLog("Save Checklist", currentChecklist.title);
      toast("Saved", `${currentChecklist.title} saved locally.`);
      renderChecks();
      renderLogs();
      bootstrap.Modal.getInstance(document.getElementById("checklistModal")).hide();
    }

    function persistChecklistState(key, value){
      localStorage.setItem("mc_checklist_" + key, JSON.stringify(value));
    }
    function loadChecklistState(key){
      const raw = localStorage.getItem("mc_checklist_" + key);
      return raw ? JSON.parse(raw) : null;
    }

    // -----------------------
    // QR Scanner (Checklist)
    // -----------------------
    function startQrScanner(targetDivId, onText){
      // Ensure html5-qrcode exists
      if (typeof Html5Qrcode === "undefined") {
        toast("QR Scanner Missing", "Html5Qrcode is not defined. Check the CDN script include.");
        return null;
      }

      const scanner = new Html5Qrcode(targetDivId);
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      scanner.start(
        { facingMode: "environment" },
        config,
        (decodedText) => onText(decodedText),
        (err) => { /* ignore scan errors */ }
      ).catch(e => {
        toast("Camera Error", (e && e.message) ? e.message : "Unable to start camera.");
      });

      return scanner;
    }

    function stopQrIfRunning(){
      if (qrScanner){
        try{
          qrScanner.stop().then(() => qrScanner.clear()).catch(()=>{});
        }catch(_){}
        qrScanner = null;
      }
    }

    function handleDecodedTextToChecklist(decodedText){
      // expected: "MED:Ondansetron" or "SUP:4x4 Gauze"
      const txt = (decodedText || "").trim();
      const upper = txt.toUpperCase();

      let type = null;
      let name = txt;

      if (upper.startsWith("MED:")) { type = "med"; name = txt.slice(4).trim(); }
      if (upper.startsWith("SUP:")) { type = "sup"; name = txt.slice(4).trim(); }

      // If type doesn't match current checklist, still allow but tag it in notes
      const row = {
        done: true,
        item: name || txt,
        doseQty: "",
        notes: type ? `Scanned (${type.toUpperCase()})` : "Scanned"
      };
      currentChecklist.rows.unshift(row);
      renderChecklistRows();
      addLog("Scan QR", txt);
      toast("Scanned", txt);
    }

    // -----------------------
    // Picker modal
    // -----------------------
    let pickerCallback = null;

    function openPicker(title, subtitle, callback){
      pickerCallback = callback;
      $("#pickerTitle").text(title);
      $("#pickerSubtitle").text(subtitle || "");
      $("#pickerSearch").val("");
      $("#pickerType").val("auto");
      renderPickerList();
      new bootstrap.Modal(document.getElementById("pickerModal")).show();
    }

    function getPickerSource(){
      const s = getSession();
      const typeSel = $("#pickerType").val();
      const autoType = (s.mode === "MedChecks") ? "med" : "sup";

      const type = typeSel === "auto" ? autoType : (typeSel === "med" ? "med" : "sup");
      const list = (type === "med") ? parseMasterLines(getMasterMeds()) : parseMasterLines(getMasterSupplies());
      return { type, list };
    }

    function renderPickerList(){
      const q = ($("#pickerSearch").val() || "").toLowerCase().trim();
      const src = getPickerSource();
      const list = src.list.filter(x => !q || x.name.toLowerCase().includes(q));
      const host = $("#pickerList");
      host.empty();

      if (!list.length){
        host.append(`<div class="text-muted">No matches.</div>`);
        return;
      }

      list.slice(0, 60).forEach(x => {
        const btn = $(`
          <button type="button" class="btn btn-light w-100 text-start mb-2">
            <b>${escapeHtml(x.name)}</b>
            <div class="small text-muted">${escapeHtml(x.doseOrPar || "")} ${x.notes ? "• " + escapeHtml(x.notes) : ""}</div>
          </button>
        `);
        btn.on("click", () => {
          if (pickerCallback) pickerCallback(src.type, x);
          bootstrap.Modal.getInstance(document.getElementById("pickerModal")).hide();
        });
        host.append(btn);
      });
    }

    // -----------------------
    // Incident
    // -----------------------
    let incidentItems = [];
    let incidentScanner = null;

    function openIncident(){
      incidentItems = [];
      $("#incidentNumber").val("");
      $("#incidentNotes").val("");
      renderIncidentRows();
      stopIncidentScanner();
      $("#qrIncidentWrap").hide();
      $("#btnIncidentStop").prop("disabled", true);
      new bootstrap.Modal(document.getElementById("incidentModal")).show();
      addLog("Open Incident", "Create incident PDF");
    }

    function renderIncidentRows(){
      const body = $("#incidentBody");
      body.empty();

      incidentItems.forEach((it, idx) => {
        body.append(`
          <tr>
            <td><span class="badge text-bg-${it.type === "med" ? "success" : "danger"}">${it.type.toUpperCase()}</span></td>
            <td><b>${escapeHtml(it.item)}</b></td>
            <td><input class="form-control form-control-sm" data-i-idx="${idx}" data-field="doseQty" value="${escapeAttr(it.doseQty || "")}"/></td>
            <td><input class="form-control form-control-sm" data-i-idx="${idx}" data-field="details" value="${escapeAttr(it.details || "")}"/></td>
            <td><button class="btn btn-sm btn-outline-danger" data-i-del="${idx}">X</button></td>
          </tr>
        `);
      });

      body.find("input[data-i-idx]").off("input").on("input", function(){
        const i = +$(this).data("i-idx");
        const f = $(this).data("field");
        incidentItems[i][f] = $(this).val();
      });

      body.find("button[data-i-del]").off("click").on("click", function(){
        const i = +$(this).data("i-del");
        incidentItems.splice(i,1);
        renderIncidentRows();
      });
    }

    function addIncidentItem(type, name){
      incidentItems.unshift({
        type,
        item: name,
        doseQty: "",
        details: ""
      });
      renderIncidentRows();
    }

    function stopIncidentScanner(){
      if (incidentScanner){
        try{
          incidentScanner.stop().then(() => incidentScanner.clear()).catch(()=>{});
        }catch(_){}
        incidentScanner = null;
      }
    }

    function handleDecodedTextToIncident(decodedText){
      const txt = (decodedText || "").trim();
      const upper = txt.toUpperCase();
      let type = null;
      let name = txt;

      if (upper.startsWith("MED:")) { type = "med"; name = txt.slice(4).trim(); }
      if (upper.startsWith("SUP:")) { type = "sup"; name = txt.slice(4).trim(); }
      if (!type){
        // default based on mode
        const s = getSession();
        type = (s.mode === "MedChecks") ? "med" : "sup";
      }
      addIncidentItem(type, name || txt);
      addLog("Scan Incident QR", txt);
      toast("Added", txt);
    }

    function exportIncidentPdf(){
      const s = getSession();
      const inc = ($("#incidentNumber").val() || "").trim();
      if (!inc){
        toast("Missing Incident #", "Enter an incident number first.");
        return;
      }

      const notes = ($("#incidentNotes").val() || "").trim();
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF){
        toast("PDF Missing", "jsPDF did not load.");
        return;
      }

      const doc = new jsPDF({ unit:"pt", format:"letter" });
      let y = 54;

      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("EMS Incident Item Summary", 54, y); y += 18;

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.text(`Incident: ${inc}`, 54, y); y += 14;
      doc.text(`Service: ${s.service}   Mode: ${s.mode}   User: ${s.user}`, 54, y); y += 14;
      if (notes){
        doc.text(`Notes: ${notes}`, 54, y); y += 14;
      }
      doc.text(`Generated: ${new Date().toLocaleString()}`, 54, y); y += 18;

      // Table header
      doc.setFont("helvetica","bold");
      doc.text("Type", 54, y);
      doc.text("Item", 120, y);
      doc.text("Dose/Qty", 360, y);
      doc.text("Details", 460, y);
      y += 10;
      doc.setLineWidth(0.5);
      doc.line(54, y, 558, y); y += 14;

      doc.setFont("helvetica","normal");
      const rows = incidentItems.slice().reverse(); // preserve input order
      if (!rows.length){
        doc.text("(No items selected)", 54, y);
      } else {
        rows.forEach(r => {
          if (y > 740){
            doc.addPage();
            y = 54;
          }
          doc.text((r.type || "").toUpperCase(), 54, y);
          doc.text(trunc(r.item, 30), 120, y);
          doc.text(trunc(r.doseQty || "", 14), 360, y);
          doc.text(trunc(r.details || "", 18), 460, y);
          y += 14;
        });
      }

      doc.save(`Incident_${inc}.pdf`);
      addLog("Export PDF", `Incident ${inc} (${incidentItems.length} items)`);
      toast("PDF Created", `Incident ${inc} exported.`);
    }

    // -----------------------
    // Scenarios
    // -----------------------
    function handleScenario(id){
      const s = getSession();
      if (!s) return;

      switch(id){
        case "scan-item":
          // open checklist for first location in current mode
          const locs = buildLocations(s);
          if (locs.length) openChecklistForLocation(locs[0]);
          else toast("No Locations", "No locations available.");
          break;

        case "daily-check":
          // open first daily check
          const defs = buildCheckDefinitions(s);
          const daily = defs.find(x => x.cadence === "daily");
          if (daily) openChecklistForCheck(daily);
          else toast("No Daily Check", "No daily check definition found.");
          break;

        case "incident":
          openIncident();
          break;

        case "report-discrep":
          toast("Discrepancy", "Prototype: Use Reports -> Report Discrepancy (log entry).");
          showView("reports");
          break;

        default:
          addLog("Scenario", id);
          toast("Scenario", `Prototype clicked: ${id}`);
      }
    }

    function handleReport(id){
      if (id === "history"){
        renderLogs();
        toast("History", "Showing latest activity below.");
        $("html, body").animate({ scrollTop: $(document).height() }, 350);
        addLog("Report", "History");
      } else if (id === "search-logs"){
        const q = prompt("Search logs for keyword:");
        if (q){
          const logs = getLogs();
          const hits = logs.filter(l => JSON.stringify(l).toLowerCase().includes(q.toLowerCase()));
          $("#logExportBox").show().text(JSON.stringify(hits.slice(0,100), null, 2));
          toast("Search", `${hits.length} hits (showing up to 100).`);
          addLog("Report", "Search logs: " + q);
          showView("reports");
        }
      } else if (id === "report-discrepancy"){
        const d = prompt("Describe discrepancy (missing/damaged/expired):");
        if (d){
          addLog("Discrepancy", d);
          toast("Discrepancy Saved", "Logged locally.");
          renderLogs();
        }
      }
    }

    // -----------------------
    // Login + service selection flow
    // -----------------------
    function doLogin(){
      const u = ($("#loginUser").val() || "").trim();
      const p = ($("#loginPass").val() || "").trim();

      let role = null;
      if (u === "admin" && p === "admin") role = "admin";
      if (u === "user" && p === "user") role = "user";

      if (!role){
        toast("Login failed", "Use admin/admin or user/user.");
        return;
      }

      // stage 1: logged in, but must select service
      const mode = "MedChecks";
      setSession({ user: u, role, mode, service: "" });

      $("#servicePickerPanel").show();
      $("#serviceSelect").val("");

      $("#whoPill").text(`${u} (${role}) • pick service`);
      $("#btnLogout").show();
      $("#adminNav").toggle(role === "admin");
      applyMode(mode);
      addLog("Login", `${u} (${role})`);
      toast("Logged in", "Now select service to continue.");
    }

    function enterApp(){
      const s = getSession();
      const svc = ($("#serviceSelect").val() || "").trim();
      if (!svc){
        toast("Service required", "Select MC1 or Lisbon.");
        return;
      }

      s.service = svc;
      setSession(s);

      // Update top pills
      $("#whoPill").text(`${s.user} (${s.role}) • ${s.service}`);
      $("#servicePill").text(s.service);
      $("#modePill").text(s.mode);
      $("#btnLogout").show();
      $("#adminNav").toggle(s.role === "admin");

      // Render all
      applyMode(s.mode);
      renderInventoryManage();
      renderChecks();
      renderIWant();
      renderReports();
      renderLogs();

      // Switch view
      showView("home");

      toast("Ready", `Service set to ${svc}.`);
      addLog("Select Service", svc);
    }

    function doLogout(){
      stopQrIfRunning();
      stopIncidentScanner();
      clearSession();
      $("#whoPill").text("Not logged in");
      $("#btnLogout").hide();
      $("#adminNav").hide();
      $("#servicePickerPanel").hide();
      showView("login");
      toast("Logged out", "Session cleared.");
    }

    // -----------------------
    // Admin
    // -----------------------
    function loadAdmin(){
      $("#adminMeds").val(getMasterMeds());
      $("#adminSupplies").val(getMasterSupplies());
    }

    function saveAdminMeds(){
      localStorage.setItem(K.meds, $("#adminMeds").val() || "");
      toast("Saved", "Med master list saved.");
      addLog("Admin Save", "Meds master list");
    }
    function saveAdminSupplies(){
      localStorage.setItem(K.supplies, $("#adminSupplies").val() || "");
      toast("Saved", "Supply master list saved.");
      addLog("Admin Save", "Supplies master list");
    }

    function resetAdminMeds(){
      localStorage.removeItem(K.meds);
      $("#adminMeds").val(getMasterMeds());
      toast("Reset", "Med list reset to defaults.");
      addLog("Admin Reset", "Meds default");
    }
    function resetAdminSupplies(){
      localStorage.removeItem(K.supplies);
      $("#adminSupplies").val(getMasterSupplies());
      toast("Reset", "Supply list reset to defaults.");
      addLog("Admin Reset", "Supplies default");
    }

    // -----------------------
    // UI: toast
    // -----------------------
    function toast(title, msg){
      const id = "t" + Math.random().toString(16).slice(2);
      const html = `
        <div class="alert alert-light border" id="${id}" style="border-radius:16px;">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div style="font-weight:900;">${escapeHtml(title)}</div>
              <div class="text-muted">${escapeHtml(msg || "")}</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('${id}').remove()">X</button>
          </div>
        </div>
      `;
      $("#toastHost").append(html);
      setTimeout(() => { document.getElementById(id)?.remove(); }, 4200);
    }

    // -----------------------
    // Utils
    // -----------------------
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(s).replaceAll("\n"," ");
    }
    function trunc(s, n){
      s = String(s || "");
      return s.length > n ? (s.slice(0, n-1) + "…") : s;
    }

    // -----------------------
    // Wire up events
    // -----------------------
    $(function(){
      // Nav
      $(document).on("click", ".nav-link[data-nav]", function(e){
        e.preventDefault();
        const key = $(this).data("nav");
        const s = getSession();

        if (key === "home"){
          if (!s || !s.service){ showView("login"); return; }
          showView("home");
        } else if (key === "iwant"){
          if (!s || !s.service){ showView("login"); return; }
          showView("iwant");
        } else if (key === "reports"){
          if (!s || !s.service){ showView("login"); return; }
          showView("reports");
        } else if (key === "help"){
          showView("help");
        } else if (key === "admin"){
          if (!s || s.role !== "admin"){ toast("Not allowed", "Admin only."); return; }
          loadAdmin();
          showView("admin");
        }
      });

      // Login
      $("#btnLogin").on("click", doLogin);
      $("#btnEnterApp").on("click", enterApp);

      // Logout
      $("#btnLogout").on("click", doLogout);

      // Mode switch
      $("#btnSwitchMode").on("click", () => {
        const s = getSession();
        if (!s){ toast("Login first","Please login first."); return; }
        s.mode = (s.mode === "MedChecks") ? "SupplyChecks" : "MedChecks";
        setSession(s);
        applyMode(s.mode);
        $("#modePill").text(s.mode);
        renderInventoryManage();
        renderChecks();
        renderIWant();
        addLog("Switch Mode", s.mode);
        toast("Mode switched", s.mode);
      });

      // Reset checks
      $("#btnResetChecks").on("click", () => {
        localStorage.removeItem(K.checks);
        toast("Reset", "Demo check status cleared.");
        addLog("Reset", "Check status");
        renderChecks();
      });

      // Checklist: save
      $("#btnSaveChecklist").on("click", saveChecklist);

      // Checklist: manual add
      $("#btnAddManual").on("click", () => {
        if (!currentChecklist) return;
        const s = getSession();
        const autoType = (s.mode === "MedChecks") ? "med" : "sup";
        openPicker(
          "Add Item",
          `To: ${currentChecklist.title}`,
          (type, item) => {
            currentChecklist.rows.unshift({
              done: false,
              item: item.name,
              doseQty: item.doseOrPar || "",
              notes: item.notes || ""
            });
            renderChecklistRows();
            addLog("Add Item", `${type.toUpperCase()}: ${item.name}`);
          }
        );
      });

      // Picker search
      $("#pickerSearch").on("input", renderPickerList);
      $("#pickerType").on("change", renderPickerList);

      // Checklist: QR scan
      $("#btnScanQr").on("click", () => {
        if (!currentChecklist) return;
        $("#qrRegionWrap").show();

        stopQrIfRunning();
        qrScanner = startQrScanner("qr-reader", (text) => {
          // stop after a successful scan to avoid rapid duplicates
          handleDecodedTextToChecklist(text);
          stopQrIfRunning();
          $("#btnStopScan").prop("disabled", true);
        });
        if (qrScanner){
          $("#btnStopScan").prop("disabled", false);
          addLog("Start QR", currentChecklist.title);
        }
      });

      $("#btnStopScan").on("click", () => {
        stopQrIfRunning();
        $("#btnStopScan").prop("disabled", true);
        $("#qrRegionWrap").hide();
        addLog("Stop QR", currentChecklist?.title || "");
      });

      // Incident modal
      $("#btnIncidentAdd").on("click", () => {
        openPicker(
          "Add Item to Incident",
          "Pick meds/supplies (you can switch type in the dropdown).",
          (type, item) => addIncidentItem(type, item.name)
        );
      });

      $("#btnIncidentScan").on("click", () => {
        $("#qrIncidentWrap").show();
        stopIncidentScanner();

        if (typeof Html5Qrcode === "undefined"){
          toast("QR Scanner Missing", "Html5Qrcode is not defined. Check the CDN script include.");
          return;
        }

        incidentScanner = new Html5Qrcode("qr-reader-incident");
        incidentScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          (decodedText) => {
            handleDecodedTextToIncident(decodedText);
            stopIncidentScanner();
            $("#btnIncidentStop").prop("disabled", true);
          },
          ()=>{}
        ).then(() => {
          $("#btnIncidentStop").prop("disabled", false);
          addLog("Start Incident QR", "Incident");
        }).catch(e => {
          toast("Camera Error", (e && e.message) ? e.message : "Unable to start camera.");
        });
      });

      $("#btnIncidentStop").on("click", () => {
        stopIncidentScanner();
        $("#btnIncidentStop").prop("disabled", true);
        $("#qrIncidentWrap").hide();
        addLog("Stop Incident QR", "Incident");
      });

      $("#btnIncidentExportPdf").on("click", exportIncidentPdf);

      // Reports buttons
      $("#btnClearLogs").on("click", () => {
        localStorage.removeItem(K.logs);
        renderLogs();
        toast("Cleared", "Logs cleared.");
      });

      $("#btnExportLogsJson").on("click", () => {
        const logs = getLogs();
        $("#logExportBox").show().text(JSON.stringify(logs, null, 2));
        toast("Export", "Logs shown as JSON below.");
      });

      // Admin saves
      $("#btnSaveMeds").on("click", saveAdminMeds);
      $("#btnSaveSupplies").on("click", saveAdminSupplies);
      $("#btnResetMeds").on("click", resetAdminMeds);
      $("#btnResetSupplies").on("click", resetAdminSupplies);

      // Initial boot
      boot();
    });

    function boot(){
      const s = getSession();
      renderLogs();

      if (!s){
        showView("login");
        $("#btnLogout").hide();
        $("#adminNav").hide();
        $("#whoPill").text("Not logged in");
        applyMode("MedChecks");
        return;
      }

      applyMode(s.mode || "MedChecks");

      $("#btnLogout").show();
      $("#adminNav").toggle(s.role === "admin");

      if (!s.service){
        // Logged in but needs service selected
        showView("login");
        $("#servicePickerPanel").show();
        $("#whoPill").text(`${s.user} (${s.role}) • pick service`);
        $("#loginUser").val(s.user || "admin");
        $("#loginPass").val(s.user === "user" ? "user" : "admin");
        return;
      }

      // Full app
      $("#whoPill").text(`${s.user} (${s.role}) • ${s.service}`);
      $("#servicePill").text(s.service);
      $("#modePill").text(s.mode);

      renderInventoryManage();
      renderChecks();
      renderIWant();
      renderReports();
      showView("home");
    }

    // Expose helpers for any inline calls if needed
    window.openIncident = openIncident;
  </script>
</body>
</html>
