<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MedChecks / SupplyChecks</title>

  <!-- Bootstrap + jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- QR Scanner -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Application Styles -->
  <link rel="stylesheet" href="./css/styles.css">
</head>

<body class="mode-med">
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg topbar sticky-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#" onclick="return false;">
        <span class="brand-badge">
          <span id="brandName">MedChecks</span>
          <span class="mini-chip" id="modeChip">MED</span>
        </span>
      </a>

      <button class="navbar-toggler btn-outline-white" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        Menu
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="#" data-nav="home">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="iwant">I want to…</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="reports">Reports</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="docs">Documentation</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="admin" id="adminNav" style="display:none;">Admin</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="sysadmin" id="sysAdminNav" style="display:none;">System Admin</a></li>
        </ul>

        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="pill" id="whoPill">Not logged in</span>
          <button class="btn-outline-white" id="btnSwitchMode" type="button">Switch Mode</button>
          <button class="btn-white" id="btnLogout" type="button" style="display:none;">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="page-wrap">

    <!-- LOGIN -->
    <div class="view active" id="view-login">
      <div class="section-card mt-3">
        <div class="section-header">
          <div>
            <h2 class="section-title mb-1">
              Login
              <span class="help-q" data-help="login">?</span>
            </h2>
            <div class="section-sub">
              Concept login (not secure). Try <span class="kbd">admin/admin</span>, <span class="kbd">svc/svc</span>, <span class="kbd">medic/medic</span>, <span class="kbd">user/user</span>.
            </div>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Username</label>
              <input id="loginUser" class="form-control form-control-lg" value="admin" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Password</label>
              <input id="loginPass" type="password" class="form-control form-control-lg" value="admin" />
            </div>
            <div class="col-12 col-md-4">
              <button id="btnLogin" class="btn btn-dark btn-lg w-100" type="button">Login</button>
              <div class="small-note mt-2">Auto-filled for quick demo.</div>
            </div>
          </div>
        </div>

        <!-- Service picker required after login -->
        <div class="panel-white mt-3" id="servicePickerPanel" style="display:none;">
          <h5 class="fw-black mb-2" style="font-weight:950;">
            Select Service <span class="text-danger">*</span>
            <span class="help-q ms-2" data-help="servicePicker">?</span>
          </h5>
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <select id="serviceSelect" class="form-select form-select-lg"></select>
              <div class="small-note mt-2">
                Service controls which locations exist (Lisbon has Units 42/43; MC1 has MC1 kits).
              </div>
            </div>
            <div class="col-12 col-md-6">
              <button id="btnEnterApp" class="btn btn-success btn-lg w-100" type="button">Enter</button>
              <div class="small-note mt-2">You must pick a service to continue.</div>
            </div>
          </div>
        </div>

        <!-- Role picker (optional in prototype) -->
        <div class="panel-white mt-3" id="rolePickerPanel" style="display:none;">
          <h5 class="fw-black mb-2" style="font-weight:950;">
            Confirm Role (Prototype)
            <span class="help-q ms-2" data-help="roles">?</span>
          </h5>
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <select id="roleSelect" class="form-select form-select-lg"></select>
              <div class="small-note mt-2">This demo assigns roles by user login; you can override here for testing.</div>
            </div>
            <div class="col-12 col-md-6">
              <button id="btnApplyRole" class="btn btn-dark btn-lg w-100" type="button">Apply Role</button>
              <div class="small-note mt-2">Only for demo/testing.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HOME -->
    <div class="view" id="view-home">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Dashboard
              <span class="help-q" data-help="dashboard">?</span>
            </h3>
            <div class="section-sub">Tap a location to perform a checklist, scan items, or run role-based actions.</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <span class="pill">Service: <b id="servicePill">—</b></span>
            <span class="pill">Role: <b id="rolePill">—</b></span>
            <span class="pill">Mode: <b id="modePill">—</b></span>
          </div>
        </div>

        <div class="grid" id="grid-inventory"></div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Scheduled Checks
              <span class="help-q" data-help="scheduledChecks">?</span>
            </h3>
            <div class="section-sub">These launch the actual checklist (not just a completion toggle).</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn-outline-white" type="button" id="btnResetChecks">Reset Demo Check Status</button>
          </div>
        </div>
        <div class="grid" id="grid-checks"></div>
      </div>
    </div>

    <!-- I WANT TO -->
    <div class="view" id="view-iwant">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              I want to…
              <span class="help-q" data-help="iwant">?</span>
            </h3>
            <div class="section-sub">Scenarios are role-aware (e.g., narcotics require Paramedic and witness for wasting).</div>
          </div>
        </div>
        <div class="grid" id="grid-iwant"></div>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="view" id="view-reports">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Reports
              <span class="help-q" data-help="reports">?</span>
            </h3>
            <div class="section-sub">Local-only (browser storage) demo reporting.</div>
          </div>
        </div>
        <div class="grid" id="grid-reports"></div>

        <div class="panel-white mt-3">
          <h5 class="mb-1" style="font-weight:950;">Recent Activity (Local Log)</h5>
          <div class="small-note">Stored in browser storage for this demo.</div>

          <div class="table-responsive mt-2">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>User</th>
                  <th>Service</th>
                  <th>Role</th>
                  <th>Mode</th>
                  <th>Action</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="logTableBody"></tbody>
            </table>
          </div>

          <div class="d-flex gap-2 flex-wrap mt-2">
            <button class="btn btn-outline-secondary" type="button" id="btnClearLogs">Clear Logs</button>
            <button class="btn btn-outline-secondary" type="button" id="btnExportLogsJson">Export Logs (JSON)</button>
          </div>

          <pre class="mt-3 p-2 rounded" style="background:#f6f7f8; border:1px solid #e5e7ea; display:none; overflow:auto; max-height: 45vh;" id="logExportBox"></pre>
        </div>
      </div>
    </div>

    <!-- DOCUMENTATION MENU PAGE (full docs) -->
    <div class="view" id="view-docs">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">Documentation</h3>
            <div class="section-sub">Full help library (also accessible via ? icons).</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn-outline-white" id="btnOpenAllDocs" type="button">Open All Topics</button>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-2" id="docsList"></div>
        </div>
      </div>
    </div>

    <!-- SERVICE ADMIN -->
    <div class="view" id="view-admin">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Admin (Service)
              <span class="help-q" data-help="serviceAdmin">?</span>
            </h3>
            <div class="section-sub">Manage master lists and service-specific settings. (Service Admin for that service, or System Admin.)</div>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h5 class="mb-1" style="font-weight:950;">Med Master List (JSON)</h5>
              <div class="small-note">Edit JSON array. Supports: name, defaultDose, isNarcotic, notes.</div>
              <textarea class="form-control" id="adminMedsJson" rows="14" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveMedsJson">Save</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetMedsJson">Reset Default</button>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <h5 class="mb-1" style="font-weight:950;">Supply Master List (JSON)</h5>
              <div class="small-note">Edit JSON array. Supports: name, par, notes.</div>
              <textarea class="form-control" id="adminSuppliesJson" rows="14" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveSuppliesJson">Save</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetSuppliesJson">Reset Default</button>
              </div>
            </div>

            <div class="col-12">
              <hr/>
              <h5 class="mb-1" style="font-weight:950;">Service Locations (JSON)</h5>
              <div class="small-note">Edit the current service’s location list. (Prototype stores in localStorage.)</div>
              <textarea class="form-control" id="adminServiceLocationsJson" rows="12" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveServiceLocationsJson">Save Locations</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetServiceLocationsJson">Reset Default</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SYSTEM ADMIN -->
    <div class="view" id="view-sysadmin">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              System Admin
              <span class="help-q" data-help="systemAdmin">?</span>
            </h3>
            <div class="section-sub">Control everything: app variants, settings, docs, services. Edit the full JSON config.</div>
          </div>
        </div>

        <div class="panel-white">
          <div class="d-flex gap-2 flex-wrap align-items-center">
            <button class="btn btn-dark" type="button" id="btnSysSaveConfig">Save Config</button>
            <button class="btn btn-outline-secondary" type="button" id="btnSysResetConfig">Reset Default Config</button>
            <button class="btn btn-outline-secondary" type="button" id="btnSysValidateConfig">Validate JSON</button>
            <span class="small-note">Edits are stored locally only.</span>
          </div>
          <hr/>
          <textarea class="form-control" id="sysConfigJson" rows="22" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- HELP MODAL -->
  <div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="helpTitle" style="font-weight:950;">Help</h5>
            <div class="small-note" id="helpSubtitle" style="color: rgba(255,255,255,.75) !important;">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="helpBody"></div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKLIST MODAL -->
  <div class="modal fade" id="checklistModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" id="checklistTitle" style="font-weight:950;">Checklist</h5>
            <div class="small-note" id="checklistSubtitle" style="color: rgba(255,255,255,.75) !important;">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex gap-2 flex-wrap mb-2 align-items-center">
            <button class="btn btn-outline-secondary" type="button" id="btnScanQr">Scan QR</button>
            <button class="btn btn-outline-secondary" type="button" id="btnStopScan" disabled>Stop Scan</button>
            <button class="btn btn-outline-secondary" type="button" id="btnAddManual">Add Manually</button>
            <button class="btn btn-outline-secondary" type="button" id="btnAddNarcManual">Add Narcotic (Paramedic)</button>
            <span class="ms-auto small-note">QR: <b>MED:</b> / <b>NARC:</b> / <b>SUP:</b></span>
          </div>

          <div id="qrRegionWrap" style="display:none;">
            <div class="p-2 rounded" style="border:1px solid #e5e7ea; background:#f8f9fa;">
              <div id="qr-reader" style="width:100%;"></div>
              <div class="small-note mt-2">If camera fails, use “Add Manually”.</div>
            </div>
          </div>

          <div class="mt-3">
            <h6 style="font-weight:950;">Checklist Items</h6>
            <div class="small-note mb-2">
              Mark an item <b>Done</b> to select it for actions (prototype rule).
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-lite">
                <thead>
                  <tr>
                    <th style="width:90px;">Done</th>
                    <th>Item</th>
                    <th style="width:140px;">Type</th>
                    <th style="width:190px;">Dose/Qty</th>
                    <th>Notes</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="checklistBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel-white mt-3">
            <h6 style="font-weight:950;">Role-Based Actions</h6>
            <div class="row g-2">
              <div class="col-12 col-lg-4">
                <button class="btn btn-dark w-100" type="button" id="btnCheckout">Check Out Selected</button>
                <div class="small-note mt-1">EMT/AEMT: non-narc meds; Paramedic: includes narcotics (MedChecks).</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-danger w-100" type="button" id="btnWaste">Waste Selected</button>
                <div class="small-note mt-1">Narcotics require witness Paramedic.</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-secondary w-100" type="button" id="btnMarkDiscrepancy">Report Discrepancy</button>
                <div class="small-note mt-1">Creates a discrepancy log entry (demo).</div>
              </div>
            </div>
          </div>

          <div class="small-note mt-2">
            Saving stores this checklist state locally and marks scheduled checks as done.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-success" type="button" id="btnSaveChecklist">Save Checklist</button>
        </div>
      </div>
    </div>
  </div>

  <!-- INCIDENT MODAL -->
  <div class="modal fade" id="incidentModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Create Incident</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Select items used + export a PDF for your run report later.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Incident Number</label>
              <input class="form-control" id="incidentNumber" placeholder="e.g., 2026-002134" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Patient / Notes (optional)</label>
              <input class="form-control" id="incidentNotes" placeholder="e.g., chest pain / SVT / trauma..." />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Location</label>
              <select class="form-select" id="incidentLocation"></select>
            </div>
          </div>

          <hr class="my-3"/>

          <div class="d-flex gap-2 flex-wrap align-items-center">
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentAdd">Add Item</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentAddNarc">Add Narcotic (Paramedic)</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentScan">Scan QR</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentStop" disabled>Stop Scan</button>
            <span class="ms-auto small-note">QR: <b>MED:</b> / <b>NARC:</b> / <b>SUP:</b></span>
          </div>

          <div id="qrIncidentWrap" style="display:none;" class="mt-2">
            <div class="p-2 rounded" style="border:1px solid #e5e7ea; background:#f8f9fa;">
              <div id="qr-reader-incident" style="width:100%;"></div>
              <div class="small-note mt-2">If narcotics are included, “Waste” requires witness Paramedic.</div>
            </div>
          </div>

          <div class="mt-3">
            <h6 style="font-weight:950;">Items Used</h6>

            <div class="table-responsive">
              <table class="table table-sm table-lite">
                <thead>
                  <tr>
                    <th style="width:120px;">Type</th>
                    <th>Item</th>
                    <th style="width:190px;">Dose/Qty</th>
                    <th>Details</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="incidentBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel-white mt-3">
            <h6 style="font-weight:950;">Incident Actions</h6>
            <div class="row g-2">
              <div class="col-12 col-lg-4">
                <button class="btn btn-dark w-100" type="button" id="btnIncidentCheckout">Check Out Items</button>
                <div class="small-note mt-1">Applies role rules for narcotics.</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-danger w-100" type="button" id="btnIncidentWaste">Waste Items</button>
                <div class="small-note mt-1">If narcotics, requires witness Paramedic.</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-secondary w-100" type="button" id="btnIncidentExportPdf">Export PDF</button>
                <div class="small-note mt-1">Client-side export.</div>
              </div>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PICKER MODAL -->
  <div class="modal fade" id="pickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" id="pickerTitle" style="font-weight:950;">Pick an Item</h5>
            <div class="small-note" id="pickerSubtitle" style="color: rgba(255,255,255,.75) !important;">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <input class="form-control" id="pickerSearch" placeholder="Search..." />
            </div>
            <div class="col-12 col-md-6">
              <select class="form-select" id="pickerType">
                <option value="auto">Auto (current mode)</option>
                <option value="med">Meds</option>
                <option value="narc">Narcotics</option>
                <option value="sup">Supplies</option>
              </select>
            </div>
          </div>
          <div class="mt-3" id="pickerList"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NARCOTIC SHIFT COUNT MODAL -->
  <div class="modal fade" id="narcShiftCountModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Narcotic Shift Count</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Dual-provider shift change narcotic count (DEA requirement).</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            Both outgoing and incoming providers must verify narcotic counts.
          </div>

          <div class="row g-3 mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Outgoing Provider</label>
              <input class="form-control" id="shiftCountOutgoing" readonly />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Incoming Provider Username</label>
              <input class="form-control" id="shiftCountIncomingUser" placeholder="Enter username" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Incoming Provider Password</label>
              <input class="form-control" id="shiftCountIncomingPass" type="password" placeholder="Enter password" />
            </div>
          </div>

          <h6 style="font-weight:950;">Narcotic Count</h6>
          <div class="table-responsive">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th>Medication</th>
                  <th>DEA Schedule</th>
                  <th style="width:120px;">Expected</th>
                  <th style="width:120px;">Actual</th>
                  <th style="width:100px;">Discrepancy</th>
                </tr>
              </thead>
              <tbody id="shiftCountBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="button" id="btnConfirmShiftCount">Confirm Count</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NARCOTIC CUSTODY TRANSFER MODAL -->
  <div class="modal fade" id="narcTransferModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Transfer Narcotic Custody</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Chain of custody documentation (DEA requirement).</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            Both transferring and receiving providers must confirm this custody transfer.
          </div>

          <div class="row g-3 mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">From (Current User)</label>
              <input class="form-control" id="transferFrom" readonly />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">To Username</label>
              <input class="form-control" id="transferToUser" placeholder="Enter username" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">To Password</label>
              <input class="form-control" id="transferToPass" type="password" placeholder="Enter password" />
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Location</label>
              <select class="form-select" id="transferLocation"></select>
            </div>
          </div>

          <h6 style="font-weight:950;">Narcotics Being Transferred</h6>
          <div class="table-responsive">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th>Medication</th>
                  <th>DEA Schedule</th>
                  <th style="width:120px;">Count</th>
                  <th style="width:150px;">Lot Number</th>
                </tr>
              </thead>
              <tbody id="transferBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="button" id="btnConfirmTransfer">Confirm Transfer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PARTIAL WASTE MODAL -->
  <div class="modal fade" id="partialWasteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Partial Dose Waste</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Document narcotic administration and waste amounts.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            Enter the amounts for narcotic partial dose waste. Administered + Wasted must equal Total.
          </div>

          <div class="row g-3">
            <div class="col-12">
              <label class="form-label fw-bold">Medication</label>
              <input class="form-control" id="partialWasteMed" readonly />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Total Amount in Vial</label>
              <input class="form-control" id="partialWasteTotal" placeholder="e.g., 100 mcg" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Amount Administered</label>
              <input class="form-control" id="partialWasteAdministered" placeholder="e.g., 50 mcg" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Amount Wasted</label>
              <input class="form-control" id="partialWasteWasted" placeholder="e.g., 50 mcg" />
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Waste Method</label>
              <select class="form-select" id="partialWasteMethod">
                <option value="">-- Select Method --</option>
                <option value="Sink">Sink</option>
                <option value="Sharps">Sharps Container</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Lot Number (Optional)</label>
              <input class="form-control" id="partialWasteLot" placeholder="Enter lot number" />
            </div>
          </div>

          <hr class="my-3"/>

          <h6 style="font-weight:950;">Witness (Required)</h6>
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Witness Username</label>
              <input class="form-control" id="partialWasteWitnessUser" placeholder="Must be Paramedic+" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Witness Password</label>
              <input class="form-control" id="partialWasteWitnessPass" type="password" placeholder="Enter password" />
            </div>
          </div>

          <div class="small-note mt-2">
            Witness must be a different Paramedic (cannot witness own waste).
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" type="button" id="btnConfirmPartialWaste">Confirm Waste</button>
        </div>
      </div>
    </div>
  </div>

  <!-- WITNESS MODAL -->
  <div class="modal fade" id="witnessModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Witness Required</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Narcotic waste requires a second Paramedic witness (prototype).</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            You selected narcotic items for <b>waste</b>. Enter witness credentials (must be Paramedic).
          </div>

          <div class="row g-2">
            <div class="col-12">
              <label class="form-label fw-bold">Witness Username</label>
              <input class="form-control" id="witnessUser" value="medic">
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Witness Password</label>
              <input class="form-control" id="witnessPass" type="password" value="medic">
            </div>
          </div>

          <div class="small-note mt-2">
            Demo witness: <b>medic/medic</b> (Paramedic) or <b>admin/admin</b> (System Admin).
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" type="button" id="btnWitnessConfirm">Confirm Witness</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MORNING TRUCK CHECK MODAL -->
  <div class="modal fade" id="truckCheckModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Morning Truck Check</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Complete check of meds, supplies, and equipment. Both crew members must sign off.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="panel-white mb-3">
            <h6 style="font-weight:950;">Crew Sign-Off</h6>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold">Crew Member 1</label>
                <input class="form-control" id="truckCheckCrew1" readonly />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold">Crew Member 2 (Partner) <span class="text-danger">*</span></label>
                <input class="form-control" id="truckCheckCrew2" placeholder="Enter partner name" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Unit Number <span class="text-danger">*</span></label>
                <input class="form-control" id="truckCheckUnit" placeholder="e.g., Unit 42" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Odometer Reading</label>
                <input class="form-control" id="truckCheckOdometer" placeholder="e.g., 45,234" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Shift Time</label>
                <input class="form-control" id="truckCheckShift" placeholder="e.g., 0700-1900" />
              </div>
            </div>
          </div>

          <div class="alert alert-info">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <b>Status:</b> <span id="truckCheckProgress">0 items checked</span>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-success" type="button" id="btnMarkInService" disabled>Mark In Service</button>
                <button class="btn btn-danger" type="button" id="btnMarkOutOfService" disabled>Mark Out of Service</button>
              </div>
            </div>
          </div>

          <h6 style="font-weight:950;">Checklist Items (All Categories)</h6>
          <div class="small-note mb-2">
            Check each item as you verify it. Critical items (equipment and narcotics) must pass for In Service status.
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th style="width:90px;">Done</th>
                  <th>Item</th>
                  <th style="width:180px;">Type</th>
                  <th style="width:190px;">Dose/Qty</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="truckCheckBody"></tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- STOCK SUPPLIES MODAL -->
  <div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Stock Supplies</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Receive and stock supplies at a location.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Destination Location <span class="text-danger">*</span></label>
              <select class="form-select" id="stockDestination"></select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Received By</label>
              <input class="form-control" id="stockReceivedBy" readonly />
            </div>
          </div>

          <div class="d-flex gap-2 flex-wrap mb-3">
            <button class="btn btn-outline-secondary" type="button" id="btnStockAddItem">Add Item</button>
          </div>

          <h6 style="font-weight:950;">Items to Stock</h6>
          <div class="table-responsive">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="width:120px;">Type</th>
                  <th style="width:150px;">Quantity</th>
                  <th style="width:120px;"></th>
                </tr>
              </thead>
              <tbody id="stockBody"></tbody>
            </table>
          </div>

          <div class="small-note mt-2">
            Add items using the "Add Item" button above. Enter quantities received.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="button" id="btnConfirmStock">Confirm Stock</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRANSFER ITEMS MODAL -->
  <div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Transfer Items</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Transfer items between locations.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">From Location <span class="text-danger">*</span></label>
              <select class="form-select" id="transferSource"></select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">To Location <span class="text-danger">*</span></label>
              <select class="form-select" id="transferDest"></select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Transferred By</label>
              <input class="form-control" id="transferBy" readonly />
            </div>
          </div>

          <div class="d-flex gap-2 flex-wrap mb-3">
            <button class="btn btn-outline-secondary" type="button" id="btnTransferAddItem">Add Item</button>
          </div>

          <h6 style="font-weight:950;">Items to Transfer</h6>
          <div class="table-responsive">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="width:120px;">Type</th>
                  <th style="width:150px;">Quantity</th>
                  <th style="width:120px;"></th>
                </tr>
              </thead>
              <tbody id="transferBody"></tbody>
            </table>
          </div>

          <div class="small-note mt-2">
            Add items using the "Add Item" button above. Enter quantities to transfer.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="button" id="btnConfirmTransfer">Confirm Transfer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-host" id="toastHost"></div>

  <!-- Application modules (load in dependency order) -->
  <script src="js/config.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/narcotics.js"></script>
  <script src="js/checklist.js"></script>
  <script src="js/incident.js"></script>
  <script src="js/admin.js"></script>
  <script src="js/sysadmin.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
