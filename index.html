<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MedChecks / SupplyChecks</title>

  <!-- Bootstrap + jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- QR Scanner -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* Dark seafoam */
      --mc-bg1:#041a18;
      --mc-bg2:#0a3431;
      --mc-accent:#2fb7a2;

      /* Dark red */
      --sc-bg1:#1b0506;
      --sc-bg2:#4b0f12;
      --sc-accent:#ff6b6b;

      --text: rgba(255,255,255,.92);
      --text-muted: rgba(255,255,255,.72);

      --card-border: rgba(255,255,255,.55);
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.07);

      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;

      --shadow-soft: 0 12px 34px rgba(0,0,0,.18);
    }

    /* ====== BACKGROUND / TYPO ====== */
    body{
      min-height:100vh;
      color: var(--text);
      background: linear-gradient(135deg, var(--mc-bg1), var(--mc-bg2));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body.mode-supply{
      background: linear-gradient(135deg, var(--sc-bg1), var(--sc-bg2));
    }

    /* ====== NAV ====== */
    .topbar{
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.25);
      border-bottom: 1px solid rgba(255,255,255,.15);
    }
    .navbar .nav-link, .navbar-brand { color: var(--text) !important; }
    .nav-link.active{ text-decoration: underline; text-underline-offset: .35rem; }
    .navbar-toggler{ border:none; }
    .navbar-toggler:focus{ box-shadow:none; }

    .brand-badge{
      border: 1px solid var(--card-border);
      border-radius: 999px;
      padding: .35rem .75rem;
      display:inline-flex;
      gap:.5rem;
      align-items:center;
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .mini-chip{
      font-size:.78rem;
      font-weight:900;
      padding:.22rem .55rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.45);
      background: rgba(255,255,255,.08);
      color: var(--text);
      white-space: nowrap;
    }
    .pill{
      border: 1px solid var(--card-border);
      border-radius: 999px;
      padding: .35rem .7rem;
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size: .9rem;
      white-space: nowrap;
    }

    /* ====== BUTTONS ====== */
    .btn-white{
      background: #fff;
      color: #0b1112;
      border: 1px solid rgba(255,255,255,.85);
      border-radius: 999px;
      font-weight: 900;
      padding: .55rem 1rem;
    }
    .btn-outline-white{
      background: transparent;
      border: 1px solid var(--card-border);
      border-radius: 999px;
      color: var(--text);
      font-weight: 900;
      padding: .55rem 1rem;
    }
    .btn-outline-white:focus, .btn-white:focus{ box-shadow:none; }
    .btn-dark, .btn-success, .btn-danger, .btn-outline-secondary, .btn-outline-danger{
      border-radius: 999px;
      font-weight: 900;
    }

    /* ====== LAYOUT ====== */
    .page-wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 1rem;
      padding-bottom: 6rem;
    }

    .section-card{
      border: 1px solid var(--card-border);
      border-radius: var(--radius-xl);
      background: var(--glass2);
      padding: 1rem;
      margin-top: 1rem;
    }

    .section-header{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 1rem;
      flex-wrap: wrap;
      padding: .25rem .25rem .75rem .25rem;
    }
    .section-title{
      display:flex;
      align-items:center;
      gap: .6rem;
      margin: 0;
      font-size: 1.15rem;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .section-sub{
      color: var(--text-muted);
      font-size: .92rem;
      margin: .2rem 0 0 0;
      line-height: 1.25rem;
    }

    .help-q{
      border:1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
    }
    .help-q:active{ transform: translateY(1px); }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .square-btn{
      grid-column: span 6;
      border-radius: var(--radius-lg);
      background: #ffffff;
      border: 1px solid rgba(255,255,255,.85);
      color: #0b1112;
      padding: 14px;
      text-align:left;
      user-select:none;
      cursor:pointer;
      min-height: 86px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      transition: transform .06s ease-in-out;
    }
    .square-btn .label{ font-weight: 950; line-height: 1.15; }
    .square-btn .meta{ font-size: .85rem; color: rgba(0,0,0,.60); margin-top: 6px; }
    .square-btn .tag{
      font-size: .75rem;
      font-weight: 950;
      padding: .25rem .5rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      color: rgba(0,0,0,.70);
      background: rgba(0,0,0,.04);
      white-space: nowrap;
    }
    .square-btn:active{ transform: translateY(1px); }

    @media (min-width: 576px){ .square-btn{ grid-column: span 4; } }
    @media (min-width: 992px){ .square-btn{ grid-column: span 3; } }

    /* ====== PANEL WHITE (INSIDE SECTIONS) ====== */
    .panel-white{
      background: rgba(255,255,255,.96);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,.85);
      padding: 14px;
      color: #0b1112;
      box-shadow: var(--shadow-soft);
    }
    .small-note{ font-size: .9rem; color: rgba(0,0,0,.65); }

    .view{ display:none; }
    .view.active{ display:block; }

    /* ====== MOBILE FRIENDLY TABLES ====== */
    .table-responsive{
      border-radius: var(--radius-md);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.92);
    }
    .table-lite{
      margin-bottom:0;
      background: transparent;
    }
    .table-lite thead th{
      background: rgba(0,0,0,.04);
      font-weight: 950;
      font-size: .9rem;
      white-space: nowrap;
    }
    .table-lite td, .table-lite th{
      padding: .6rem .65rem;
      vertical-align: middle;
    }
    .table-lite td b{ font-weight: 900; }

    /* Make inputs in tables mobile-friendly */
    .table-lite input.form-control-sm{
      min-width: 120px;
      border-radius: 12px;
    }

    /* ====== MODALS (THEMED) ====== */
    .modal-content{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.15);
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
      overflow:hidden;
    }

    /* Header gradient changes with mode */
    body:not(.mode-supply) .modal-header{
      background: linear-gradient(135deg, rgba(4,26,24,.98), rgba(10,52,49,.98));
      color: var(--text);
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
    body.mode-supply .modal-header{
      background: linear-gradient(135deg, rgba(27,5,6,.98), rgba(75,15,18,.98));
      color: var(--text);
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
    .modal-header .btn-close{
      filter: invert(1);
      opacity: .9;
    }
    .modal-body{
      background: rgba(255,255,255,.98);
      color: #0b1112;
    }
    .modal-footer{
      background: rgba(255,255,255,.98);
      border-top: 1px solid rgba(0,0,0,.08);
    }
    .modal .small-note{ color: rgba(0,0,0,.65); }
    .modal .alert{ border-radius: 16px; }
    .modal .form-control, .modal .form-select{
      border-radius: 14px;
    }

    /* QR Regions in modals */
    #qrRegionWrap .p-2, #qrIncidentWrap .p-2{
      border-radius: 16px !important;
    }
    #qr-reader, #qr-reader-incident{
      border-radius: 16px;
      overflow: hidden;
    }

    /* Better modal spacing on mobile */
    @media (max-width: 576px){
      .modal-dialog{ margin: .75rem; }
      .modal-body{ padding: 1rem; }
      .modal-footer{ padding: .75rem 1rem; }
      .section-card{ padding: .85rem; }
      .panel-white{ padding: 12px; }
      .square-btn{ min-height: 82px; }
      .navbar .pill{ display:none; } /* keep nav clean on small screens */
    }

    /* ====== TOAST HOST ====== */
    .toast-host{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      width: min(560px, calc(100% - 24px));
    }
    .toast-host .alert{
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
    }

    /* Inline code pill */
    .kbd{
      border: 1px solid rgba(255,255,255,.30);
      border-bottom-width: 2px;
      border-radius: 10px;
      padding: 2px 7px;
      font-weight: 950;
      font-size: .85rem;
      color: var(--text);
      background: rgba(255,255,255,.08);
      white-space: nowrap;
    }
  </style>
</head>

<body class="mode-med">
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg topbar sticky-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#" onclick="return false;">
        <span class="brand-badge">
          <span id="brandName">MedChecks</span>
          <span class="mini-chip" id="modeChip">MED</span>
        </span>
      </a>

      <button class="navbar-toggler btn-outline-white" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        Menu
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="#" data-nav="home">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="iwant">I want to…</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="reports">Reports</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="docs">Documentation</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="admin" id="adminNav" style="display:none;">Admin</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-nav="sysadmin" id="sysAdminNav" style="display:none;">System Admin</a></li>
        </ul>

        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="pill" id="whoPill">Not logged in</span>
          <button class="btn-outline-white" id="btnSwitchMode" type="button">Switch Mode</button>
          <button class="btn-white" id="btnLogout" type="button" style="display:none;">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="page-wrap">

    <!-- LOGIN -->
    <div class="view active" id="view-login">
      <div class="section-card mt-3">
        <div class="section-header">
          <div>
            <h2 class="section-title mb-1">
              Login
              <span class="help-q" data-help="login">?</span>
            </h2>
            <div class="section-sub">
              Concept login (not secure). Try <span class="kbd">admin/admin</span>, <span class="kbd">svc/svc</span>, <span class="kbd">medic/medic</span>, <span class="kbd">user/user</span>.
            </div>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Username</label>
              <input id="loginUser" class="form-control form-control-lg" value="admin" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Password</label>
              <input id="loginPass" class="form-control form-control-lg" value="admin" />
            </div>
            <div class="col-12 col-md-4">
              <button id="btnLogin" class="btn btn-dark btn-lg w-100" type="button">Login</button>
              <div class="small-note mt-2">Auto-filled for quick demo.</div>
            </div>
          </div>
        </div>

        <!-- Service picker required after login -->
        <div class="panel-white mt-3" id="servicePickerPanel" style="display:none;">
          <h5 class="fw-black mb-2" style="font-weight:950;">
            Select Service <span class="text-danger">*</span>
            <span class="help-q ms-2" data-help="servicePicker">?</span>
          </h5>
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <select id="serviceSelect" class="form-select form-select-lg"></select>
              <div class="small-note mt-2">
                Service controls which locations exist (Lisbon has Units 42/43; MC1 has MC1 kits).
              </div>
            </div>
            <div class="col-12 col-md-6">
              <button id="btnEnterApp" class="btn btn-success btn-lg w-100" type="button">Enter</button>
              <div class="small-note mt-2">You must pick a service to continue.</div>
            </div>
          </div>
        </div>

        <!-- Role picker (optional in prototype) -->
        <div class="panel-white mt-3" id="rolePickerPanel" style="display:none;">
          <h5 class="fw-black mb-2" style="font-weight:950;">
            Confirm Role (Prototype)
            <span class="help-q ms-2" data-help="roles">?</span>
          </h5>
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <select id="roleSelect" class="form-select form-select-lg"></select>
              <div class="small-note mt-2">This demo assigns roles by user login; you can override here for testing.</div>
            </div>
            <div class="col-12 col-md-6">
              <button id="btnApplyRole" class="btn btn-dark btn-lg w-100" type="button">Apply Role</button>
              <div class="small-note mt-2">Only for demo/testing.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HOME -->
    <div class="view" id="view-home">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Dashboard
              <span class="help-q" data-help="dashboard">?</span>
            </h3>
            <div class="section-sub">Tap a location to perform a checklist, scan items, or run role-based actions.</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <span class="pill">Service: <b id="servicePill">—</b></span>
            <span class="pill">Role: <b id="rolePill">—</b></span>
            <span class="pill">Mode: <b id="modePill">—</b></span>
          </div>
        </div>

        <div class="grid" id="grid-inventory"></div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Scheduled Checks
              <span class="help-q" data-help="scheduledChecks">?</span>
            </h3>
            <div class="section-sub">These launch the actual checklist (not just a completion toggle).</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn-outline-white" type="button" id="btnResetChecks">Reset Demo Check Status</button>
          </div>
        </div>
        <div class="grid" id="grid-checks"></div>
      </div>
    </div>

    <!-- I WANT TO -->
    <div class="view" id="view-iwant">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              I want to…
              <span class="help-q" data-help="iwant">?</span>
            </h3>
            <div class="section-sub">Scenarios are role-aware (e.g., narcotics require Paramedic and witness for wasting).</div>
          </div>
        </div>
        <div class="grid" id="grid-iwant"></div>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="view" id="view-reports">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Reports
              <span class="help-q" data-help="reports">?</span>
            </h3>
            <div class="section-sub">Local-only (browser storage) demo reporting.</div>
          </div>
        </div>
        <div class="grid" id="grid-reports"></div>

        <div class="panel-white mt-3">
          <h5 class="mb-1" style="font-weight:950;">Recent Activity (Local Log)</h5>
          <div class="small-note">Stored in browser storage for this demo.</div>

          <div class="table-responsive mt-2">
            <table class="table table-sm table-lite">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>User</th>
                  <th>Service</th>
                  <th>Role</th>
                  <th>Mode</th>
                  <th>Action</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="logTableBody"></tbody>
            </table>
          </div>

          <div class="d-flex gap-2 flex-wrap mt-2">
            <button class="btn btn-outline-secondary" type="button" id="btnClearLogs">Clear Logs</button>
            <button class="btn btn-outline-secondary" type="button" id="btnExportLogsJson">Export Logs (JSON)</button>
          </div>

          <pre class="mt-3 p-2 rounded" style="background:#f6f7f8; border:1px solid #e5e7ea; display:none; overflow:auto; max-height: 45vh;" id="logExportBox"></pre>
        </div>
      </div>
    </div>

    <!-- DOCUMENTATION MENU PAGE (full docs) -->
    <div class="view" id="view-docs">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">Documentation</h3>
            <div class="section-sub">Full help library (also accessible via ? icons).</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn-outline-white" id="btnOpenAllDocs" type="button">Open All Topics</button>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-2" id="docsList"></div>
        </div>
      </div>
    </div>

    <!-- SERVICE ADMIN -->
    <div class="view" id="view-admin">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              Admin (Service)
              <span class="help-q" data-help="serviceAdmin">?</span>
            </h3>
            <div class="section-sub">Manage master lists and service-specific settings. (Service Admin for that service, or System Admin.)</div>
          </div>
        </div>

        <div class="panel-white">
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <h5 class="mb-1" style="font-weight:950;">Med Master List (JSON)</h5>
              <div class="small-note">Edit JSON array. Supports: name, defaultDose, isNarcotic, notes.</div>
              <textarea class="form-control" id="adminMedsJson" rows="14" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveMedsJson">Save</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetMedsJson">Reset Default</button>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <h5 class="mb-1" style="font-weight:950;">Supply Master List (JSON)</h5>
              <div class="small-note">Edit JSON array. Supports: name, par, notes.</div>
              <textarea class="form-control" id="adminSuppliesJson" rows="14" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveSuppliesJson">Save</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetSuppliesJson">Reset Default</button>
              </div>
            </div>

            <div class="col-12">
              <hr/>
              <h5 class="mb-1" style="font-weight:950;">Service Locations (JSON)</h5>
              <div class="small-note">Edit the current service’s location list. (Prototype stores in localStorage.)</div>
              <textarea class="form-control" id="adminServiceLocationsJson" rows="12" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button class="btn btn-dark" type="button" id="btnSaveServiceLocationsJson">Save Locations</button>
                <button class="btn btn-outline-secondary" type="button" id="btnResetServiceLocationsJson">Reset Default</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SYSTEM ADMIN -->
    <div class="view" id="view-sysadmin">
      <div class="section-card">
        <div class="section-header">
          <div>
            <h3 class="section-title mb-1">
              System Admin
              <span class="help-q" data-help="systemAdmin">?</span>
            </h3>
            <div class="section-sub">Control everything: app variants, settings, docs, services. Edit the full JSON config.</div>
          </div>
        </div>

        <div class="panel-white">
          <div class="d-flex gap-2 flex-wrap align-items-center">
            <button class="btn btn-dark" type="button" id="btnSysSaveConfig">Save Config</button>
            <button class="btn btn-outline-secondary" type="button" id="btnSysResetConfig">Reset Default Config</button>
            <button class="btn btn-outline-secondary" type="button" id="btnSysValidateConfig">Validate JSON</button>
            <span class="small-note">Edits are stored locally only.</span>
          </div>
          <hr/>
          <textarea class="form-control" id="sysConfigJson" rows="22" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- HELP MODAL -->
  <div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="helpTitle" style="font-weight:950;">Help</h5>
            <div class="small-note" id="helpSubtitle" style="color: rgba(255,255,255,.75) !important;">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="helpBody"></div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKLIST MODAL -->
  <div class="modal fade" id="checklistModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" id="checklistTitle" style="font-weight:950;">Checklist</h5>
            <div class="small-note" id="checklistSubtitle" style="color: rgba(255,255,255,.75) !important;">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex gap-2 flex-wrap mb-2 align-items-center">
            <button class="btn btn-outline-secondary" type="button" id="btnScanQr">Scan QR</button>
            <button class="btn btn-outline-secondary" type="button" id="btnStopScan" disabled>Stop Scan</button>
            <button class="btn btn-outline-secondary" type="button" id="btnAddManual">Add Manually</button>
            <button class="btn btn-outline-secondary" type="button" id="btnAddNarcManual">Add Narcotic (Paramedic)</button>
            <span class="ms-auto small-note">QR: <b>MED:</b> / <b>NARC:</b> / <b>SUP:</b></span>
          </div>

          <div id="qrRegionWrap" style="display:none;">
            <div class="p-2 rounded" style="border:1px solid #e5e7ea; background:#f8f9fa;">
              <div id="qr-reader" style="width:100%;"></div>
              <div class="small-note mt-2">If camera fails, use “Add Manually”.</div>
            </div>
          </div>

          <div class="mt-3">
            <h6 style="font-weight:950;">Checklist Items</h6>
            <div class="small-note mb-2">
              Mark an item <b>Done</b> to select it for actions (prototype rule).
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-lite">
                <thead>
                  <tr>
                    <th style="width:90px;">Done</th>
                    <th>Item</th>
                    <th style="width:140px;">Type</th>
                    <th style="width:190px;">Dose/Qty</th>
                    <th>Notes</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="checklistBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel-white mt-3">
            <h6 style="font-weight:950;">Role-Based Actions</h6>
            <div class="row g-2">
              <div class="col-12 col-lg-4">
                <button class="btn btn-dark w-100" type="button" id="btnCheckout">Check Out Selected</button>
                <div class="small-note mt-1">EMT/AEMT: non-narc meds; Paramedic: includes narcotics (MedChecks).</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-danger w-100" type="button" id="btnWaste">Waste Selected</button>
                <div class="small-note mt-1">Narcotics require witness Paramedic.</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-secondary w-100" type="button" id="btnMarkDiscrepancy">Report Discrepancy</button>
                <div class="small-note mt-1">Creates a discrepancy log entry (demo).</div>
              </div>
            </div>
          </div>

          <div class="small-note mt-2">
            Saving stores this checklist state locally and marks scheduled checks as done.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-success" type="button" id="btnSaveChecklist">Save Checklist</button>
        </div>
      </div>
    </div>
  </div>

  <!-- INCIDENT MODAL -->
  <div class="modal fade" id="incidentModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Create Incident</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Select items used + export a PDF for your run report later.</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Incident Number</label>
              <input class="form-control" id="incidentNumber" placeholder="e.g., 2026-002134" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Patient / Notes (optional)</label>
              <input class="form-control" id="incidentNotes" placeholder="e.g., chest pain / SVT / trauma..." />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Location</label>
              <select class="form-select" id="incidentLocation"></select>
            </div>
          </div>

          <hr class="my-3"/>

          <div class="d-flex gap-2 flex-wrap align-items-center">
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentAdd">Add Item</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentAddNarc">Add Narcotic (Paramedic)</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentScan">Scan QR</button>
            <button class="btn btn-outline-secondary" type="button" id="btnIncidentStop" disabled>Stop Scan</button>
            <span class="ms-auto small-note">QR: <b>MED:</b> / <b>NARC:</b> / <b>SUP:</b></span>
          </div>

          <div id="qrIncidentWrap" style="display:none;" class="mt-2">
            <div class="p-2 rounded" style="border:1px solid #e5e7ea; background:#f8f9fa;">
              <div id="qr-reader-incident" style="width:100%;"></div>
              <div class="small-note mt-2">If narcotics are included, “Waste” requires witness Paramedic.</div>
            </div>
          </div>

          <div class="mt-3">
            <h6 style="font-weight:950;">Items Used</h6>

            <div class="table-responsive">
              <table class="table table-sm table-lite">
                <thead>
                  <tr>
                    <th style="width:120px;">Type</th>
                    <th>Item</th>
                    <th style="width:190px;">Dose/Qty</th>
                    <th>Details</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="incidentBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel-white mt-3">
            <h6 style="font-weight:950;">Incident Actions</h6>
            <div class="row g-2">
              <div class="col-12 col-lg-4">
                <button class="btn btn-dark w-100" type="button" id="btnIncidentCheckout">Check Out Items</button>
                <div class="small-note mt-1">Applies role rules for narcotics.</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-danger w-100" type="button" id="btnIncidentWaste">Waste Items</button>
                <div class="small-note mt-1">If narcotics, requires witness Paramedic.</div>
              </div>
              <div class="col-12 col-lg-4">
                <button class="btn btn-outline-secondary w-100" type="button" id="btnIncidentExportPdf">Export PDF</button>
                <div class="small-note mt-1">Client-side export.</div>
              </div>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PICKER MODAL -->
  <div class="modal fade" id="pickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" id="pickerTitle" style="font-weight:950;">Pick an Item</h5>
            <div class="small-note" id="pickerSubtitle" style="color: rgba(255,255,255,.75) !important;">—</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <input class="form-control" id="pickerSearch" placeholder="Search..." />
            </div>
            <div class="col-12 col-md-6">
              <select class="form-select" id="pickerType">
                <option value="auto">Auto (current mode)</option>
                <option value="med">Meds</option>
                <option value="narc">Narcotics</option>
                <option value="sup">Supplies</option>
              </select>
            </div>
          </div>
          <div class="mt-3" id="pickerList"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- WITNESS MODAL -->
  <div class="modal fade" id="witnessModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <div class="me-3">
            <h5 class="modal-title" style="font-weight:950;">Witness Required</h5>
            <div class="small-note" style="color: rgba(255,255,255,.75) !important;">Narcotic waste requires a second Paramedic witness (prototype).</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            You selected narcotic items for <b>waste</b>. Enter witness credentials (must be Paramedic).
          </div>

          <div class="row g-2">
            <div class="col-12">
              <label class="form-label fw-bold">Witness Username</label>
              <input class="form-control" id="witnessUser" value="medic">
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Witness Password</label>
              <input class="form-control" id="witnessPass" value="medic">
            </div>
          </div>

          <div class="small-note mt-2">
            Demo witness: <b>medic/medic</b> (Paramedic) or <b>admin/admin</b> (System Admin).
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" type="button" id="btnWitnessConfirm">Confirm Witness</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-host" id="toastHost"></div>

  <!-- Application modules (load in dependency order) -->
  <script src="js/config.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/narcotics.js"></script>
  <script src="js/checklist.js"></script>
  <script src="js/incident.js"></script>
  <script src="js/admin.js"></script>
  <script src="js/sysadmin.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
